SELECT KAT_бнгпюяр,[2021],[2022]
FROM 
(SELECT  яASE WHEN DATEDIFF(YEAR,о.дюрю_пнфдемхъ, GETDATE())BETWEEN 18 AND 30 THEN '18-30 кер'
			 WHEN DATEDIFF(YEAR,о.дюрю_пнфдемхъ, GETDATE())BETWEEN 31 AND 39 THEN '31-39 кер'
			 WHEN DATEDIFF(YEAR,о.дюрю_пнфдемхъ, GETDATE())BETWEEN 40 AND 55 THEN '40-55 кер'
			 WHEN DATEDIFF(YEAR,о.дюрю_пнфдемхъ, GETDATE()) >=60 THEN '60 кер х ярюпье'
         END AS KAT_бнгпюяр, дм.хд_оюжхемрю, дм.цнд_нап
 FROM (SELECT д.хд_оюжхемрю,YEAR(д.дюрю_напюыемхъ) AS цнд_нап
	  FROM  дхюцмнг д JOIN мнгнкнцхъ м ON д.хд_мнгнкнцхх=м.хд)
	  WHERE м.мюгбюмхе='нпх' AND MONTH(д.дюрю_напюыемхъ)=1 
	 ) дм JOIN  оюжхемрш  о ON дм.хд_оюжхемрю=о.хд
)  AS SourceTable  
PIVOT
( 
 COUNT(д.хд_оюжхемрю)
 FOR цнд_нап IN ( [2021], [2022])
 ) AS PivotTable

 SELECT х.хд_хгбеыемхъ, о.тхн_оюжхемрю, б.тхн_бпювю, н.мюгбюмхе_нрдекемхе, 
       CASE DATEDIFF(DAY,д.дюрю_дхюцмнгю,х.дюрю_хгбеыемхъ) <=1 THEN 'нропюбкемн б япнй'
			DATEDIFF(DAY,д.дюрю_дхюцмнгю,х.дюрю_хгбеыемхъ) >1  THEN'нропюбкемн я нонгдюмхел'
			х.дюрю_хгбеыемхъ ISNULL THEN 'ме нропюбкемн'
 FROM  дхюцмнг  д LEFT JOIN щйярпеммне_хгбеыемхе х ON х.хд_дхюцмнгю=д.хд JOIN оюжхемрш о ON д.хд_оюжхемрю=о.хд 
		JOIN бпювх б ON д.хд_бпювю=б.хд JOIN нрдекемхъ н ON б.хд_нрдекемхъ=н.хд
 WHERE х.дюрю_хгбеыемхъ>='2022-01-01' AND х.дюрю_хгбеыемхъ<='2022-02-01' 

